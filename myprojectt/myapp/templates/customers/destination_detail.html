{% extends 'base.html' %}
 {% load static %}
  {% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ destination.name }} Tour Itinerary</title>

  {% comment %} <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"> {% endcomment %}
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      --primary: #8e44ad;
      --secondary: #e67e22;
      --accent: #27ae60;
      --light: #f5f6fa;
      --dark: #2c3e50;
      --text: #34495e;
    }

    body {
      background-image: url("{% static 'images/features-background1.jpg' %}");
      color: var(--text);
     font-family: "Roboto", sans-serif;
    }

    .hero {
      position: relative;
      height: 60vh;
      overflow: hidden;
      margin-bottom: 2rem;
    }
    
    #map {
      height: 100%;
      width: 100%;
      z-index: 1;
    }
    
    .destination-header {
      margin-bottom: 2rem;
    }
    
    .destination-title {
      color: var(--primary);
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .destination-tagline {
      color: var(--dark);
      font-size: 1.2rem;
    }
    
    .car-marker {
      position: relative;
      transform-origin: center;
      transition: transform 0.2s ease-out;
    }

    .car-marker img {
      width: 48px;
      height: 48px;
      transform-origin: center center;
      filter: drop-shadow(0 0 5px rgba(0,0,0,0.3));
      animation: bounce 0.5s infinite alternate;
    }
    
    @keyframes bounce {
      from { transform: translateY(0) rotate(var(--rotation)); }
      to { transform: translateY(-1px) rotate(var(--rotation)); }
    }

    .day-card {
      border-left: 5px solid var(--primary);
      background-color: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
      margin-bottom: 40px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .day-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .day-number {
      font-size: 1.6rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 12px;
    }

    .highlight-box {
      background-color: rgba(231, 76, 60, 0.05);
      border-left: 4px solid var(--secondary);
      padding: 15px;
      border-radius: 5px;
      margin-top: 15px;
      color: var(--dark);
      font-style: italic;
    }

    .btn-book {
      background: var(--primary);
      color: white;
      padding: 12px 28px;
      font-size: 1.1rem;
      border-radius: 50px;
      border: none;
      text-decoration: none;
      transition: background 0.3s;
    }

    .btn-book:hover {
      background: var(--secondary);
    }

    .section-title h2 {
      color: var(--primary);
      font-weight: bold;
    }

    .section-title p {
      color: var(--dark);
    }
    
    .custom-back-btn {
     
      color: white;
      background-color: transparent;
      transition: all 0.3s ease;
      font-weight: 500;
      border-radius: 50px;
      padding: 8px 20px;
    }

    .custom-back-btn:hover {
      background-color: var(--secondary);
      color: white;
    }

    .custom-back-btn svg {
      transition: transform 0.3s ease;
    }

    .custom-back-btn:hover svg {
      transform: translateX(-4px);
    }

    /* Route selector styles */
    .route-selector {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .route-selector select {
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }

    /* Custom red location icon */
    .red-icon {
      background-color: red;
      border-radius: 50%;
      border: 2px solid white;
      width: 20px;
      height: 20px;
      display: block;
    }

    .red-icon::after {
      content: "";
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid red;
    }

    /* Intermediate point markers */
    .waypoint-icon {
      background-color: #3498db;
      border-radius: 50%;
      border: 2px solid white;
      width: 12px;
      height: 12px;
      display: block;
    }
    
    /* Route point tags */
    .route-point-tag {
      position: absolute;
      background: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      white-space: nowrap;
      transform: translate(-50%, -100%);
      margin-top: -10px;
      z-index: 100;
    }
    
    .route-point-tag::after {
      content: "";
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 4px solid white;
    }
    
    .distance-badge {
      background-color: var(--accent);
      color: white;
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 4px;
      margin-left: 4px;
    }
    
    /* Destination tag styling */
    .destination-tag {
      background-color: rgba(255, 0, 0, 0.1);
      border-left: 3px solid red;
    }

    /* Hide routing machine controls */
    .leaflet-routing-container {
      display: none;
    }

    /* Confetti canvas */
    #confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <!-- Hero Section with Map -->
  <section class="hero">
    <div id="map"></div>
    <!-- Route selector -->
    <div id="routeSelector" class="route-selector" style="display: none;">
      <label for="routeOption">Select Route:</label>
      <select id="routeOption">
        <option value="fastest">Fastest Route</option>
        <option value="scenic">Scenic Route</option>
        <option value="historic">Historic Route</option>
      </select>
    </div>
  </section>
  
  <div class="container">
    <!-- Destination Header -->
    <div class="destination-header">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="destination-title">{{ destination.name }} Tour</h1>
          <p class="destination-tagline">{{ destination.tagline }}</p>
        </div>
        <div>
          <a href="{% url 'all_destinations' %}" class="btn custom-back-btn d-inline-flex align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-left-circle me-2" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0-1A6 6 0 1 0 8 2a6 6 0 0 0 0 12z"/>
              <path fill-rule="evenodd" d="M8.354 11.354a.5.5 0 0 1-.708 0L5.5 9.207l-.354.353a.5.5 0 0 1-.708-.707l1.5-1.5a.5.5 0 0 1 .708 0l1.5 1.5a.5.5 0 0 1 0 .707z"/>
              <path fill-rule="evenodd" d="M11.5 8a.5.5 0 0 1-.5.5H5a.5.5 0 0 1 0-1h6a.5.5 0 0 1 .5.5z"/>
            </svg>
            Back to All Destinations
          </a>
        </div>
      </div>
    </div>

    <section class="py-5">
      <div class="container">
        <div class="text-center mb-5 section-title">
          <h2>{{ destination.duration }} Itinerary</h2>
          <p>Explore the charm of {{ destination.name }} day by day</p>
        </div>

        {% for day in destination.itinerary %}
          <div class="day-card" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:1 }}00">
            <div class="day-number">Day {{ day.day }}: {{ day.title }}</div>
            <ul class="mb-3">
              {% for activity in day.activities %}
                <li>{{ activity }}</li>
              {% endfor %}
            </ul>
            <div class="highlight-box">
              <strong>Highlight:</strong> {{ day.highlight }}
            </div>
          </div>
        {% endfor %}

        <div class="text-center mt-5">
          <a href="https://forms.gle/qKpo3btNDZfFWBXs8" class="btn-book">Book This Tour</a>
        </div>
      </div>
    </section>
  </div>

  {% comment %} <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script> {% endcomment %}
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script>
    AOS.init();

    // Destination coordinates lookup with multiple routes
    const DESTINATION_COORDINATES = {
      "Chennai": { 
        coords: [13.0827, 80.2707],
        routes: {
          fastest: [
            {coords: [9.9252, 78.1198], name: "Madurai"},
            {coords: [10.0654, 78.3344], name: "Melur"},
            {coords: [10.5200, 78.2300], name: "Trichy"},
            {coords: [11.6643, 78.1460], name: "Vellore"},
            {coords: [12.9716, 79.1586], name: "Kanchipuram"},
            {coords: [13.0827, 80.2707], name: "Chennai"}
          ],
          scenic: [
            {coords: [9.9252, 78.1198], name: "Madurai"},
            {coords: [10.3000, 78.4000], name: "Dindigul"},
            {coords: [11.1271, 78.6569], name: "Salem"},
            {coords: [12.5200, 78.5000], name: "Krishnagiri"},
            {coords: [13.0827, 80.2707], name: "Chennai"}
          ],
          historic: [
            {coords: [9.9252, 78.1198], name: "Madurai"},
            {coords: [10.7867, 79.1378], name: "Thanjavur"},
            {coords: [11.0168, 76.9558], name: "Coimbatore"},
            {coords: [11.3410, 77.7172], name: "Erode"},
            {coords: [12.5200, 78.5000], name: "Krishnagiri"},
            {coords: [13.0827, 80.2707], name: "Chennai"}
          ]
        }
      },
      "Kodaikanal": { 
        coords: [10.2381, 77.4892],
        routes: {
          fastest: [
            {coords: [9.9252, 78.1198], name: "Madurai"},
            {coords: [10.0654, 78.3344], name: "Melur"},
            {coords: [10.1153, 78.4467], name: "Tirumangalam"},
            {coords: [10.2381, 77.4892], name: "Kodaikanal"}
          ],
          scenic: [
            {coords: [9.9252, 78.1198], name: "Madurai"},
            {coords: [10.3000, 78.4000], name: "Dindigul"},
            {coords: [10.2381, 77.4892], name: "Kodaikanal"}
          ],
          historic: [
            {coords: [9.9252, 78.1198], name: "Madurai"},
            {coords: [10.0654, 78.3344], name: "Melur"},
            {coords: [10.5200, 78.2300], name: "Trichy"},
            {coords: [10.2381, 77.4892], name: "Kodaikanal"}
          ]
        }
      },
      "Ooty": { 
        coords: [11.4102, 76.6950],
        routes: {
          fastest: [
            {coords: [9.9252, 78.1198], name: "Madurai"},
            {coords: [10.3000, 78.4000], name: "Dindigul"},
            {coords: [11.1271, 78.6569], name: "Salem"},
            {coords: [11.4102, 76.6950], name: "Ooty"}
          ],
          scenic: [
            {coords: [9.9252, 78.1198], name: "Madurai"},
            {coords: [10.0654, 78.3344], name: "Melur"},
            {coords: [10.5200, 78.2300], name: "Trichy"},
            {coords: [11.4102, 76.6950], name: "Ooty"}
          ],
          historic: [
            {coords: [9.9252, 78.1198], name: "Madurai"},
            {coords: [10.7867, 79.1378], name: "Thanjavur"},
            {coords: [11.0168, 76.9558], name: "Coimbatore"},
            {coords: [11.4102, 76.6950], name: "Ooty"}
          ]
        }
      },
      "Mahabalipuram": { 
        coords: [12.6208, 80.1949],
        routes: {
          fastest: [
            {coords: [9.9252, 78.1198], name: "Madurai"},
            {coords: [10.5200, 78.2300], name: "Trichy"},
            {coords: [11.6643, 78.1460], name: "Vellore"},
            {coords: [12.6208, 80.1949], name: "Mahabalipuram"}
          ],
          scenic: [
            {coords: [9.9252, 78.1198], name: "Madurai"},
            {coords: [10.3000, 78.4000], name: "Dindigul"},
            {coords: [11.1271, 78.6569], name: "Salem"},
            {coords: [12.6208, 80.1949], name: "Mahabalipuram"}
          ],
          historic: [
            {coords: [9.9252, 78.1198], name: "Madurai"},
            {coords: [10.7867, 79.1378], name: "Thanjavur"},
            {coords: [11.6643, 78.1460], name: "Vellore"},
            {coords: [12.6208, 80.1949], name: "Mahabalipuram"}
          ]
        }
      },
      "Kanyakumari": { 
        coords: [8.0883, 77.5385],
        routes: {
          fastest: [
            {coords: [9.9252, 78.1198], name: "Madurai"},
            {coords: [9.3000, 77.8500], name: "Rajapalayam"},
            {coords: [8.8000, 77.5000], name: "Tirunelveli"},
            {coords: [8.0883, 77.5385], name: "Kanyakumari"}
          ],
          scenic: [
            {coords: [9.9252, 78.1198], name: "Madurai"},
            {coords: [9.2882, 79.3127], name: "Rameshwaram"},
            {coords: [8.8000, 77.5000], name: "Tirunelveli"},
            {coords: [8.0883, 77.5385], name: "Kanyakumari"}
          ],
          historic: [
            {coords: [9.9252, 78.1198], name: "Madurai"},
            {coords: [9.3000, 77.8500], name: "Rajapalayam"},
            {coords: [8.7300, 77.7000], name: "Nagercoil"},
            {coords: [8.0883, 77.5385], name: "Kanyakumari"}
          ]
        }
      },
      "Chettinad": {
        coords: [10.1500, 78.8000],
        routes: {
          fastest: [
            { coords: [9.9252, 78.1198], name: "Madurai" },
            { coords: [10.0654, 78.3344], name: "Melur" },
            { coords: [10.2167, 78.5667], name: "Karaikudi" },
            { coords: [10.1500, 78.8000], name: "Chettinad" }
          ],
          scenic: [
            { coords: [9.9252, 78.1198], name: "Madurai" },
            { coords: [9.2882, 79.3127], name: "Rameshwaram" },
            { coords: [9.8733, 78.8675], name: "Sivaganga" },
            { coords: [10.1500, 78.8000], name: "Chettinad" }
          ],
          historic: [
            { coords: [9.9252, 78.1198], name: "Madurai" },
            { coords: [10.5200, 78.2300], name: "Trichy" },
            { coords: [10.4633, 78.5996], name: "Pudukkottai" },
            { coords: [10.2167, 78.5667], name: "Karaikudi" },
            { coords: [10.1500, 78.8000], name: "Chettinad" }
          ]
        }
      },
        "Rameshwaram": { 
  coords: [9.2882, 79.3127],
  routes: {
    fastest: [
      { name: "Madurai", coords: [9.9252, 78.1198] },
      { name: "Rameshwaram", coords: [9.2882, 79.3127] }
    ],
    scenic: [
      { name: "Madurai", coords: [9.9252, 78.1198] },
      { name: "Srivilliputhur", coords: [9.4551, 77.6597] }, // Andal Temple + Hills
      { name: "Ramanathapuram", coords: [9.3762, 78.8344] }, // Coastal town
      { name: "Mandapam", coords: [9.3310, 79.1880] }, // Near Pamban Bridge
      { name: "Rameshwaram", coords: [9.2882, 79.3127] }
    ],
    historic: [
      { name: "Madurai", coords: [9.9252, 78.1198] }, // Meenakshi Temple
      { name: "Melur", coords: [10.0654, 78.3344] }, // Historic region
      { name: "Paramakudi", coords: [9.5412, 78.4555] }, // Heritage town
      { name: "Gulf of Mannar Biosphere", coords: [9.3711, 79.0141] }, // Historic marine reserve
      { name: "Rameshwaram", coords: [9.2882, 79.3127] }
    ]
  }
},
  "Thanjavur": {
    coords: [10.7867, 79.1378],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [10.7867, 79.1378], name: "Thanjavur"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [10.7867, 79.1378], name: "Thanjavur"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [10.4633, 78.5996], name: "Pudukkottai"},
        {coords: [10.7867, 79.1378], name: "Thanjavur"}
      ]
    }
  },
  "Yercaud": {
    coords: [11.7750, 78.2080],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [11.1271, 78.6569], name: "Salem"},
        {coords: [11.7750, 78.2080], name: "Yercaud"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [11.3410, 77.7172], name: "Erode"},
        {coords: [11.7750, 78.2080], name: "Yercaud"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [11.7750, 78.2080], name: "Yercaud"}
      ]
    }
  },
  "Coonoor": {
    coords: [11.3548, 76.8016],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [11.1271, 78.6569], name: "Salem"},
        {coords: [11.3548, 76.8016], name: "Coonoor"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [11.3548, 76.8016], name: "Coonoor"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [10.7867, 79.1378], name: "Thanjavur"},
        {coords: [11.3548, 76.8016], name: "Coonoor"}
      ]
    }
  },
  "Kumbakonam": {
    coords: [10.9595, 79.3885],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [10.9595, 79.3885], name: "Kumbakonam"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [10.7867, 79.1378], name: "Thanjavur"},
        {coords: [10.9595, 79.3885], name: "Kumbakonam"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [10.4633, 78.5996], name: "Pudukkottai"},
        {coords: [10.9595, 79.3885], name: "Kumbakonam"}
      ]
    }
  },
  "Velankanni": {
    coords: [10.6833, 79.8333],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [10.6833, 79.8333], name: "Velankanni"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [10.7867, 79.1378], name: "Thanjavur"},
        {coords: [10.6833, 79.8333], name: "Velankanni"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [10.4633, 78.5996], name: "Pudukkottai"},
        {coords: [10.6833, 79.8333], name: "Velankanni"}
      ]
    }
  },
  "Hogenakkal": {
    coords: [12.1167, 77.7667],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [11.1271, 78.6569], name: "Salem"},
        {coords: [12.1167, 77.7667], name: "Hogenakkal"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [11.3410, 77.7172], name: "Erode"},
        {coords: [12.1167, 77.7667], name: "Hogenakkal"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.1167, 77.7667], name: "Hogenakkal"}
      ]
    }
  },
  "Courtallam": {
    coords: [8.9333, 77.2667],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [9.3000, 77.8500], name: "Rajapalayam"},
        {coords: [8.9333, 77.2667], name: "Courtallam"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [9.2882, 79.3127], name: "Rameshwaram"},
        {coords: [8.8000, 77.5000], name: "Tirunelveli"},
        {coords: [8.9333, 77.2667], name: "Courtallam"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [9.3000, 77.8500], name: "Rajapalayam"},
        {coords: [8.7300, 77.7000], name: "Nagercoil"},
        {coords: [8.9333, 77.2667], name: "Courtallam"}
      ]
    }
  },
  "Kovalam": {
    coords: [8.4000, 77.0000],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [9.3000, 77.8500], name: "Rajapalayam"},
        {coords: [8.4000, 77.0000], name: "Kovalam"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [9.2882, 79.3127], name: "Rameshwaram"},
        {coords: [8.8000, 77.5000], name: "Tirunelveli"},
        {coords: [8.4000, 77.0000], name: "Kovalam"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [9.3000, 77.8500], name: "Rajapalayam"},
        {coords: [8.7300, 77.7000], name: "Nagercoil"},
        {coords: [8.4000, 77.0000], name: "Kovalam"}
      ]
    }
  },
  "Pollachi": {
    coords: [10.6589, 77.0085],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [10.6589, 77.0085], name: "Pollachi"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [10.6589, 77.0085], name: "Pollachi"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [10.6589, 77.0085], name: "Pollachi"}
      ]
    }
  },
  "Tranquebar": {
    coords: [11.0333, 79.8500],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [11.0333, 79.8500], name: "Tranquebar"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [10.7867, 79.1378], name: "Thanjavur"},
        {coords: [11.0333, 79.8500], name: "Tranquebar"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [10.4633, 78.5996], name: "Pudukkottai"},
        {coords: [11.0333, 79.8500], name: "Tranquebar"}
      ]
    }
  },
  "Valparai": {
    coords: [10.3269, 76.9512],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [10.3269, 76.9512], name: "Valparai"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [10.3269, 76.9512], name: "Valparai"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [10.3269, 76.9512], name: "Valparai"}
      ]
    }
  },
  "Dhanushkodi": {
    coords: [9.1550, 79.4500],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [9.2882, 79.3127], name: "Rameshwaram"},
        {coords: [9.1550, 79.4500], name: "Dhanushkodi"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [9.4551, 77.6597], name: "Srivilliputhur"},
        {coords: [9.2882, 79.3127], name: "Rameshwaram"},
        {coords: [9.1550, 79.4500], name: "Dhanushkodi"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [9.5412, 78.4555], name: "Paramakudi"},
        {coords: [9.2882, 79.3127], name: "Rameshwaram"},
        {coords: [9.1550, 79.4500], name: "Dhanushkodi"}
      ]
    }
  },
  "Kolli Hills": {
    coords: [11.3167, 78.3333],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [11.3167, 78.3333], name: "Kolli Hills"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [11.3167, 78.3333], name: "Kolli Hills"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [11.3167, 78.3333], name: "Kolli Hills"}
      ]
    }
  },
  "Vellore": {
    coords: [12.9202, 79.1333],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [11.1271, 78.6569], name: "Salem"},
        {coords: [12.9202, 79.1333], name: "Vellore"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [11.3410, 77.7172], name: "Erode"},
        {coords: [12.9202, 79.1333], name: "Vellore"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.9202, 79.1333], name: "Vellore"}
      ]
    }
  },
  "Srirangam": {
    coords: [10.8667, 78.6833],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [10.8667, 78.6833], name: "Srirangam"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [10.8667, 78.6833], name: "Srirangam"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [10.8667, 78.6833], name: "Srirangam"}
      ]
    }
  },
  "Chidambaram": {
    coords: [11.3994, 79.6939],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [11.3994, 79.6939], name: "Chidambaram"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [11.3994, 79.6939], name: "Chidambaram"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [11.3994, 79.6939], name: "Chidambaram"}
      ]
    }
  },
  "Gangaikondacholapuram": {
    coords: [11.2056, 79.4506],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [11.2056, 79.4506], name: "Gangaikondacholapuram"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [11.2056, 79.4506], name: "Gangaikondacholapuram"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [11.2056, 79.4506], name: "Gangaikondacholapuram"}
      ]
    }
  },
  "Darasuram": {
    coords: [10.9481, 79.3569],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [10.9481, 79.3569], name: "Darasuram"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [10.9481, 79.3569], name: "Darasuram"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [10.9481, 79.3569], name: "Darasuram"}
      ]
    }
  },
  "Tiruvannamalai": {
    coords: [12.2260, 79.0745],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [12.2260, 79.0745], name: "Tiruvannamalai"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [12.2260, 79.0745], name: "Tiruvannamalai"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [12.2260, 79.0745], name: "Tiruvannamalai"}
      ]
    }
  },
  "Kanchipuram": {
    coords: [12.8342, 79.7036],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [12.8342, 79.7036], name: "Kanchipuram"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [12.8342, 79.7036], name: "Kanchipuram"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [12.8342, 79.7036], name: "Kanchipuram"}
      ]
    }
  },
  "Mudumalai": {
    coords: [11.6000, 76.5000],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [11.6000, 76.5000], name: "Mudumalai"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [11.6000, 76.5000], name: "Mudumalai"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [11.6000, 76.5000], name: "Mudumalai"}
      ]
    }
  },
  "Vedanthangal": {
    coords: [12.5467, 79.8556],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [12.5467, 79.8556], name: "Vedanthangal"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [12.5467, 79.8556], name: "Vedanthangal"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [12.5467, 79.8556], name: "Vedanthangal"}
      ]
    }
  },
  "Pichavaram": {
    coords: [11.4333, 79.7833],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [11.4333, 79.7833], name: "Pichavaram"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [11.4333, 79.7833], name: "Pichavaram"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [11.4333, 79.7833], name: "Pichavaram"}
      ]
    }
  },
  "Yelagiri": {
    coords: [12.5833, 78.6333],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [12.5833, 78.6333], name: "Yelagiri"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [12.5833, 78.6333], name: "Yelagiri"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [12.5833, 78.6333], name: "Yelagiri"}
      ]
    }
  },
  "Thoothukudi": {
    coords: [8.7833, 78.1333],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [9.3000, 77.8500], name: "Rajapalayam"},
        {coords: [8.7833, 78.1333], name: "Thoothukudi"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [9.2882, 79.3127], name: "Rameshwaram"},
        {coords: [8.7833, 78.1333], name: "Thoothukudi"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [9.3000, 77.8500], name: "Rajapalayam"},
        {coords: [8.7833, 78.1333], name: "Thoothukudi"}
      ]
    }
  },
  "Karaikudi": {
    coords: [10.0667, 78.7833],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0667, 78.7833], name: "Karaikudi"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [10.0667, 78.7833], name: "Karaikudi"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [10.0667, 78.7833], name: "Karaikudi"}
      ]
    }
  },
  "Kovilpatti": {
    coords: [9.1667, 77.8667],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [9.3000, 77.8500], name: "Rajapalayam"},
        {coords: [9.1667, 77.8667], name: "Kovilpatti"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [9.2882, 79.3127], name: "Rameshwaram"},
        {coords: [9.1667, 77.8667], name: "Kovilpatti"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [9.3000, 77.8500], name: "Rajapalayam"},
        {coords: [9.1667, 77.8667], name: "Kovilpatti"}
      ]
    }
  },
  "Salem": {
    coords: [11.6648, 78.1460],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.3000, 78.4000], name: "Dindigul"},
        {coords: [11.6648, 78.1460], name: "Salem"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.5200, 78.2300], name: "Trichy"},
        {coords: [11.6648, 78.1460], name: "Salem"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0654, 78.3344], name: "Melur"},
        {coords: [11.6648, 78.1460], name: "Salem"}
      ]
    }
  },
  "Erode": {
  coords: [11.3410, 77.7172],
  routes: {
    fastest: [
      {coords: [9.9252, 78.1198], name: "Madurai"},
      {coords: [10.3000, 78.4000], name: "Dindigul"},
      {coords: [11.3410, 77.7172], name: "Erode"}
    ],
    scenic: [
      {coords: [9.9252, 78.1198], name: "Madurai"},
      {coords: [10.5200, 78.2300], name: "Trichy"},
      {coords: [11.0168, 76.9558], name: "Coimbatore"},
      {coords: [11.3410, 77.7172], name: "Erode"}
    ],
    historic: [
      {coords: [9.9252, 78.1198], name: "Madurai"},
      {coords: [10.0654, 78.3344], name: "Melur"},
      {coords: [10.7867, 79.1378], name: "Thanjavur"},
      {coords: [11.3410, 77.7172], name: "Erode"}
    ]
  }
},

    };

    // Get destination name from page title
    const destinationName = document.querySelector('.destination-title').textContent.replace(' Tour', '').trim();
    const destinationInfo = DESTINATION_COORDINATES[destinationName] || { 
      coords: [13.0827, 80.2707],
      routes: {
        fastest: [
          {coords: [9.9252, 78.1198], name: "Madurai"},
          {coords: [13.0827, 80.2707], name: "Chennai"}
        ]
      }
    };
    const destinationCoords = destinationInfo.coords;

    // Initialize the map
    const startPoint = [9.9252, 78.1198];
    const map = L.map('map').setView([
      (startPoint[0] + destinationCoords[0]) / 2,
      (startPoint[1] + destinationCoords[1]) / 2
    ], 8);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Create custom icons
    const redIcon = L.divIcon({
      className: 'red-icon',
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    });

    const waypointIcon = L.divIcon({
      className: 'waypoint-icon',
      iconSize: [12, 12],
      iconAnchor: [6, 6]
    });

    // Add markers
    L.marker(startPoint).addTo(map).bindPopup("Starting Point: Madurai");
    const destinationMarker = L.marker(destinationCoords, { icon: redIcon }).addTo(map);

    // Show route selector if multiple routes are available
    if (destinationInfo.routes && Object.keys(destinationInfo.routes).length > 1) {
      document.getElementById('routeSelector').style.display = 'block';
    }

    // Car marker setup
    const carElement = document.createElement('div');
    carElement.className = 'car-marker';
    carElement.innerHTML = `<img src="{% static 'images/topcarview.png' %}" class="car-icon" />`;

    const carIcon = L.divIcon({
      html: carElement,
      className: '',
      iconSize: [32, 32],
      iconAnchor: [16, 16],
    });

    // Animation variables
    let currentPosition = 0;
    let currentSpeed = 0;
    const targetSpeed = 0.5; // Increased speed
    const acceleration = 0.005; // Faster acceleration
    let animationId = null;
    let smoothedRoute = [];
    let currentRoute = null;
    let routeControl = null;
    let waypointMarkers = [];
    let routePointTags = [];
    let totalDistance = 0;
    let lastAngle = 0;
    const angleSmoothingFactor = 0.2;
    let lastFrameTime = 0;
    const targetFPS = 60; // Higher frame rate for smoother animation
    let hasReachedDestination = false;

    const carMarker = L.marker(startPoint, { icon: carIcon }).addTo(map);

    // Initialize Routing Machine
    const routingControl = L.Routing.control({
      waypoints: [],
      routeWhileDragging: false,
      show: false,
      addWaypoints: false,
      draggableWaypoints: false,
      fitSelectedRoutes: false,
      lineOptions: {
        styles: [{color: '#3498db', opacity: 0.7, weight: 7}]
      }
    }).addTo(map);

    // Start the trip
    fetchRoute();

    // Route selector event listener
    document.getElementById('routeOption')?.addEventListener('change', function() {
      const selectedRoute = this.value;
      if (destinationInfo.routes && destinationInfo.routes[selectedRoute]) {
        currentRoute = destinationInfo.routes[selectedRoute];
        processRoute(currentRoute);
      }
    });

    function fetchRoute() {
      if (destinationInfo.routes) {
        const routeOption = document.getElementById('routeOption')?.value || 'fastest';
        currentRoute = destinationInfo.routes[routeOption] || destinationInfo.routes.fastest;
        processRoute(currentRoute);
      } else {
        // Use Routing Machine for realistic routes
        routingControl.setWaypoints([
          L.latLng(startPoint[0], startPoint[1]),
          L.latLng(destinationCoords[0], destinationCoords[1])
        ]);
        
        routingControl.on('routesfound', function(e) {
          const routes = e.routes;
          const route = routes[0].coordinates.map(coord => [coord.lat, coord.lng]);
          processRoute([{coords: startPoint, name: "Madurai"}, {coords: destinationCoords, name: destinationName}], route);
        });
      }
    }

    function processRoute(routePoints, coordinates = null) {
      // Clear existing elements
      if (routeControl) {
        map.removeControl(routeControl);
      }
      
      waypointMarkers.forEach(marker => map.removeLayer(marker));
      waypointMarkers = [];
      
      routePointTags.forEach(tag => map.removeLayer(tag));
      routePointTags = [];

      // Reset animation state
      hasReachedDestination = false;
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }

      // Convert route to array of coordinates if it's an array of objects
      const routeCoords = coordinates || routePoints.map(point => point.coords || point);
      const routeNames = routePoints.map(point => point.name || null);

      // Calculate total distance using Routing Machine or fallback
      if (coordinates) {
        routingControl.on('routesfound', function(e) {
          totalDistance = e.routes[0].summary.totalDistance / 1000; // Convert to km
          updateRouteVisuals(routePoints, routeCoords);
        });
      } else {
        totalDistance = 0;
        for (let i = 0; i < routeCoords.length - 1; i++) {
          totalDistance += calculateDistance(
            routeCoords[i][0], routeCoords[i][1],
            routeCoords[i+1][0], routeCoords[i+1][1]
          );
        }
        updateRouteVisuals(routePoints, routeCoords);
      }
    }

    function updateRouteVisuals(routePoints, routeCoords) {
      // Add route point tags with distance information
      let cumulativeDistance = 0;
      for (let i = 0; i < routePoints.length; i++) {
        const point = routePoints[i].coords;
        const name = routePoints[i].name;
        
        if (i > 0) {
          const prevPoint = routePoints[i-1].coords;
          cumulativeDistance += calculateDistance(
            prevPoint[0], prevPoint[1],
            point[0], point[1]
          );
        }
        
        // Create tag for all route points
        const isDestination = i === routePoints.length - 1;
        const tag = L.divIcon({
          className: `route-point-tag ${isDestination ? 'destination-tag' : ''}`,
          html: `${name || (isDestination ? 'Destination' : `Point ${i+1}`)} <span class="distance-badge">${Math.round(cumulativeDistance)}km</span>`,
          iconSize: [100, 30],
          iconAnchor: [50, 30]
        });
        
        const marker = L.marker(point, { icon: tag, zIndexOffset: 1000 }).addTo(map);
        routePointTags.push(marker);
        
        // Add waypoint markers for intermediate points
        if (i > 0 && i < routePoints.length - 1) {
          const marker = L.marker(point, { icon: waypointIcon }).addTo(map);
          waypointMarkers.push(marker);
        }
      }

      // Update destination marker
      destinationMarker.setPopupContent(
        `<b>Destination:</b> ${destinationName}<br><b>Total Distance:</b> ${Math.round(totalDistance)}km`
      );

      // Create curved route using Routing Machine
      const waypoints = routePoints.map(point => 
        L.latLng(point.coords[0], point.coords[1])
      );
      
      routeControl = L.Routing.control({
        waypoints: waypoints,
        routeWhileDragging: false,
        show: false,
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        lineOptions: {
          styles: [{
            color: getRouteColor(),
            opacity: 0.7,
            weight: 7
          }]
        }
      }).addTo(map);

      // Get the actual route coordinates for animation
      routeControl.on('routesfound', function(e) {
        const routes = e.routes;
        smoothedRoute = routes[0].coordinates.map(coord => [coord.lat, coord.lng]);
        
        // Reset and start animation
        if (animationId) {
          cancelAnimationFrame(animationId);
        }
        currentPosition = 0;
        currentSpeed = 0;
        lastFrameTime = 0;
        hasReachedDestination = false;
        startTrip();
      });
    }

    function getRouteColor() {
      if (!destinationInfo.routes) return '#3498db';
      
      const routeOption = document.getElementById('routeOption')?.value || 'fastest';
      if (routeOption === 'scenic') return '#27ae60';
      if (routeOption === 'historic') return '#e67e22';
      return '#3498db';
    }

    // Haversine formula for distance calculation
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function deg2rad(deg) {
      return deg * (Math.PI/180);
    }

    function startTrip() {
      lastFrameTime = 0;
      animationId = requestAnimationFrame(animate);
    }

    function animate(timestamp) {
      if (!lastFrameTime) lastFrameTime = timestamp;
      const deltaTime = timestamp - lastFrameTime;
      
      if (deltaTime >= 1000 / targetFPS) {
          lastFrameTime = timestamp;
          
          // Speed control
          if (currentSpeed < targetSpeed) {
              currentSpeed = Math.min(currentSpeed + acceleration, targetSpeed);
          }
          
          currentPosition += currentSpeed / 1000;
          
          if (currentPosition >= 1) {
              currentPosition = 1;
              currentSpeed = 0;
              updateCarPosition(currentPosition);
              if (!hasReachedDestination) {
                triggerConfetti();
                hasReachedDestination = true;
              }
              return;
          }
          
          updateCarPosition(currentPosition);
      }
      
      animationId = requestAnimationFrame(animate);
    }

    function cubicInterpolate(y0, y1, y2, y3, mu) {
      const mu2 = mu * mu;
      const a0 = y3 - y2 - y0 + y1;
      const a1 = y0 - y1 - a0;
      const a2 = y2 - y0;
      const a3 = y1;
      return a0 * mu * mu2 + a1 * mu2 + a2 * mu + a3;
    }

    function updateCarPosition(progress) {
      const exactIndex = progress * (smoothedRoute.length - 1);
      const index = Math.floor(exactIndex);
      const nextIndex = Math.min(index + 1, smoothedRoute.length - 1);
      const partialProgress = exactIndex % 1;

      // Use cubic interpolation for smoother movement
      const prevIndex = Math.max(index - 1, 0);
      const nextNextIndex = Math.min(index + 2, smoothedRoute.length - 1);
      
      const currentPoint = smoothedRoute[index];
      const nextPoint = smoothedRoute[nextIndex];
      const prevPoint = smoothedRoute[prevIndex];
      const nextNextPoint = smoothedRoute[nextNextIndex];

      // Cubic interpolation for latitude
      const lat = cubicInterpolate(
          prevPoint[0], currentPoint[0], nextPoint[0], nextNextPoint[0], 
          partialProgress
      );
      
      // Cubic interpolation for longitude
      const lng = cubicInterpolate(
          prevPoint[1], currentPoint[1], nextPoint[1], nextNextPoint[1], 
          partialProgress
      );

      // Update car position
      carMarker.setLatLng([lat, lng]);
      
      // Calculate angle between current and next point
      const rawAngle = calculateAngle(currentPoint, nextPoint);
      const smoothedAngle = lastAngle + angleSmoothingFactor * (rawAngle - lastAngle);
      lastAngle = smoothedAngle;
      
      // Update car rotation
      carElement.style.setProperty('--rotation', `${smoothedAngle}deg`);
      
      // Smooth panning
      const bounds = map.getBounds();
      if (!bounds.contains([lat, lng])) {
          map.panTo([lat, lng], { animate: true, duration: 0.5 });
      }
    }

    function calculateAngle(currentPos, nextPos) {
      const dx = nextPos[1] - currentPos[1];
      const dy = nextPos[0] - currentPos[0];
      return Math.atan2(dx, dy) * 180 / Math.PI;
    }

    function triggerConfetti() {
      // Get the destination position on screen
      const destPoint = map.latLngToContainerPoint(destinationMarker.getLatLng());
      const x = destPoint.x / map.getSize().x;
      const y = destPoint.y / map.getSize().y;
      
      // Confetti configuration
      const colors = ['#8e44ad', '#e67e22', '#27ae60', '#3498db', '#f1c40f'];
      
      // Create confetti effect
      const end = Date.now() + 3000; // 3 seconds of confetti
      
      (function frame() {
        // Launch from left side
        confetti({
          particleCount: 5,
          angle: 60,
          spread: 55,
          origin: { x, y },
          colors: colors
        });
        
        // Launch from right side
        confetti({
          particleCount: 5,
          angle: 120,
          spread: 55,
          origin: { x, y },
          colors: colors
        });
        
        // Launch from bottom
        confetti({
          particleCount: 5,
          angle: -90,
          spread: 55,
          origin: { x, y },
          colors: colors
        });
        
        // Continue if we're not done yet
        if (Date.now() < end) {
          requestAnimationFrame(frame);
        }
        
        // Open destination popup
        destinationMarker.openPopup();
      }());
    }
  </script>
</body>
</html>
  {% endblock %}