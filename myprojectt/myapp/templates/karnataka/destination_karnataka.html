{% extends 'base.html' %}
{% load static %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ destination.name }} Tour Itinerary</title>

  {% comment %} <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"> {% endcomment %}
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      --primary: #8e44ad;
      --secondary: #e67e22;
      --accent: #27ae60;
      --light: #f5f6fa;
      --dark: #2c3e50;
      --text: #34495e;
    }

    body {
      background-image: url("{% static 'images/features-background1.jpg' %}");
      color: var(--text);
     font-family: "Roboto", sans-serif;
    }

    .hero {
      position: relative;
      height: 60vh;
      overflow: hidden;
      margin-bottom: 2rem;
    }
    
    #map {
      height: 100%;
      width: 100%;
      z-index: 1;
    }
    
    .destination-header {
      margin-bottom: 2rem;
    }
    
    .destination-title {
      color: var(--primary);
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .destination-tagline {
      color: var(--dark);
      font-size: 1.2rem;
    }
    
    .car-marker {
      position: relative;
      transform-origin: center;
      transition: transform 0.2s ease-out;
    }

    .car-marker img {
      width: 48px;
      height: 48px;
      transform-origin: center center;
      filter: drop-shadow(0 0 5px rgba(0,0,0,0.3));
      animation: bounce 0.5s infinite alternate;
    }
    
    @keyframes bounce {
      from { transform: translateY(0) rotate(var(--rotation)); }
      to { transform: translateY(-1px) rotate(var(--rotation)); }
    }

    .day-card {
      border-left: 5px solid var(--primary);
      background-color: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
      margin-bottom: 40px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .day-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .day-number {
      font-size: 1.6rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 12px;
    }

    .highlight-box {
      background-color: rgba(231, 76, 60, 0.05);
      border-left: 4px solid var(--secondary);
      padding: 15px;
      border-radius: 5px;
      margin-top: 15px;
      color: var(--dark);
      font-style: italic;
    }

    .btn-book {
       background: linear-gradient(744deg, #af40ff, #a9a1dc 60%, #05e7f7);
      color: white;
      padding: 12px 28px;
      font-size: 1.1rem;
      border-radius: 50px;
      border: none;
      text-decoration: none;
      transition: background 0.3s;
    }

    .btn-book:hover {
     background-image: linear-gradient(120deg,rgb(175, 224, 61) 0%,rgb(117, 240, 134) 100%);
    }

    .section-title h2 {
      color: var(--primary);
      font-weight: bold;
    }

    .section-title p {
      color: var(--dark);
    }
    
    .custom-back-btn {
    
      color: white;
      background-color: transparent;
      transition: all 0.3s ease;
      font-weight: 500;
      border-radius: 50px;
      padding: 8px 20px;
    }

    .custom-back-btn:hover {
      background-color: var(--secondary);
      color: white;
    }

    .custom-back-btn svg {
      transition: transform 0.3s ease;
    }

    .custom-back-btn:hover svg {
      transform: translateX(-4px);
    }

    /* Route selector styles */
    .route-selector {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .route-selector select {
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }

    /* Custom red location icon */
    .red-icon {
      background-color: red;
      border-radius: 50%;
      border: 2px solid white;
      width: 20px;
      height: 20px;
      display: block;
    }

    .red-icon::after {
      content: "";
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid red;
    }

    /* Intermediate point markers */
    .waypoint-icon {
      background-color: #3498db;
      border-radius: 50%;
      border: 2px solid white;
      width: 12px;
      height: 12px;
      display: block;
    }
    
    /* Route point tags */
    .route-point-tag {
      position: absolute;
      background: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      white-space: nowrap;
      transform: translate(-50%, -100%);
      margin-top: -10px;
      z-index: 100;
    }
    
    .route-point-tag::after {
      content: "";
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 4px solid white;
    }
    
    .distance-badge {
      background-color: var(--accent);
      color: white;
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 4px;
      margin-left: 4px;
    }
    
    /* Destination tag styling */
    .destination-tag {
      background-color: rgba(255, 0, 0, 0.1);
      border-left: 3px solid red;
    }

    /* Hide routing machine controls */
    .leaflet-routing-container {
      display: none;
    }

    /* Confetti canvas */
    #confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <!-- Hero Section with Map -->
  <section class="hero">
    <div id="map"></div>
    <!-- Route selector -->
    <div id="routeSelector" class="route-selector" style="display: none;">
      <label for="routeOption">Select Route:</label>
      <select id="routeOption">
        <option value="fastest">Fastest Route</option>
        <option value="scenic">Scenic Route</option>
        <option value="historic">Historic Route</option>
      </select>
    </div>
  </section>
  
  <div class="container">
    <!-- Destination Header -->
    <div class="destination-header">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="destination-title">{{ destination.name }} Tour</h1>
          <p class="destination-tagline">{{ destination.tagline }}</p>
        </div>
        <div>
          <a href="{% url 'all_karnataka' %}" class="btn custom-back-btn d-inline-flex align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-left-circle me-2" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0-1A6 6 0 1 0 8 2a6 6 0 0 0 0 12z"/>
              <path fill-rule="evenodd" d="M8.354 11.354a.5.5 0 0 1-.708 0L5.5 9.207l-.354.353a.5.5 0 0 1-.708-.707l1.5-1.5a.5.5 0 0 1 .708 0l1.5 1.5a.5.5 0 0 1 0 .707z"/>
              <path fill-rule="evenodd" d="M11.5 8a.5.5 0 0 1-.5.5H5a.5.5 0 0 1 0-1h6a.5.5 0 0 1 .5.5z"/>
            </svg>
            Back to All Destinations
          </a>
        </div>
      </div>
    </div>

    <section class="py-5">
      <div class="container">
        <div class="text-center mb-5 section-title">
          <h2>{{ destination.duration }} Itinerary</h2>
          <p>Explore the charm of {{ destination.name }} day by day</p>
        </div>

        {% for day in destination.itinerary %}
          <div class="day-card" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:1 }}00">
            <div class="day-number">Day {{ day.day }}: {{ day.title }}</div>
            <ul class="mb-3">
              {% for activity in day.activities %}
                <li>{{ activity }}</li>
              {% endfor %}
            </ul>
            <div class="highlight-box">
              <strong>Highlight:</strong> {{ day.highlight }}
            </div>
          </div>
        {% endfor %}

        <div class="text-center mt-5">
          <a href="https://forms.gle/qKpo3btNDZfFWBXs8" class="btn-book">Book This Tour</a>
        </div>
      </div>
    </section>
  </div>

  {% comment %} <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script> {% endcomment %}
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script>
  AOS.init();

    // Destination coordinates lookup with multiple routes
  const DESTINATION_COORDINATES = {
    'bangalore': { 
    coords: [12.9716, 77.5946],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.9716, 77.5946], name: "Bangalore"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.9716, 77.5946], name: "Bangalore"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.9716, 77.5946], name: "Bangalore"}
      ]
    }
  },
  "mysore": { 
    coords: [12.2958, 76.6394],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.2958, 76.6394], name: "Mysore"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.2958, 76.6394], name: "Mysore"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.4201, 76.6954], name: "Srirangapatna"},
        {coords: [12.2958, 76.6394], name: "Mysore"}
      ]
    }
  },
  "hampi": { 
    coords: [15.3350, 76.4600],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [15.3350, 76.4600], name: "Hampi"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [15.3350, 76.4600], name: "Hampi"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [15.3350, 76.4600], name: "Hampi"}
      ]
    }
  },
  "coorg": { 
    coords: [12.3375, 75.8069],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.3375, 75.8069], name: "Coorg"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.3375, 75.8069], name: "Coorg"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.3375, 75.8069], name: "Coorg"}
      ]
    }
  },
  "chikmagalur": { 
    coords: [13.3161, 75.7720],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.9716, 77.5946], name: "Bangalore"},
        {coords: [13.3161, 75.7720], name: "Chikmagalur"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.9716, 77.5946], name: "Bangalore"},
        {coords: [13.3161, 75.7720], name: "Chikmagalur"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.9716, 77.5946], name: "Bangalore"},
        {coords: [13.3161, 75.7720], name: "Chikmagalur"}
      ]
    }
  },
  "gokarna": { 
    coords: [14.5500, 74.3167],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.5500, 74.3167], name: "Gokarna"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.5500, 74.3167], name: "Gokarna"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.5500, 74.3167], name: "Gokarna"}
      ]
    }
  },
  "badami": { 
    coords: [15.9149, 75.6768],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [15.9149, 75.6768], name: "Badami"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [15.9149, 75.6768], name: "Badami"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [15.9149, 75.6768], name: "Badami"}
      ]
    }
  },
  "pattadakal": { 
    coords: [15.9494, 75.8156],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [15.9494, 75.8156], name: "Pattadakal"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [15.9494, 75.8156], name: "Pattadakal"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [15.9494, 75.8156], name: "Pattadakal"}
      ]
    }
  },
  "aihole": { 
    coords: [16.0119, 75.8833],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [16.0119, 75.8833], name: "Aihole"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [16.0119, 75.8833], name: "Aihole"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [16.0119, 75.8833], name: "Aihole"}
      ]
    }
  },
  "belur": { 
    coords: [13.1655, 75.8656],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.1655, 75.8656], name: "Belur"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.1655, 75.8656], name: "Belur"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.1655, 75.8656], name: "Belur"}
      ]
    }
  },
  "halebidu": { 
    coords: [13.2167, 75.9833],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.2167, 75.9833], name: "Halebidu"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.2167, 75.9833], name: "Halebidu"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.2167, 75.9833], name: "Halebidu"}
      ]
    }
  },
  "shravanabelagola": { 
    coords: [12.8573, 76.4888],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.8573, 76.4888], name: "Shravanabelagola"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.8573, 76.4888], name: "Shravanabelagola"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.8573, 76.4888], name: "Shravanabelagola"}
      ]
    }
  },
  "jog Falls": { 
    coords: [14.2294, 74.8110],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.2294, 74.8110], name: "Jog Falls"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.2294, 74.8110], name: "Jog Falls"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.2294, 74.8110], name: "Jog Falls"}
      ]
    }
  },
  "bandipur": { 
    coords: [11.6660, 76.6287],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [11.6660, 76.6287], name: "Bandipur"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [11.6660, 76.6287], name: "Bandipur"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [11.6660, 76.6287], name: "Bandipur"}
      ]
    }
  },
  "nagarhole": { 
    coords: [12.0280, 76.1262],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.0280, 76.1262], name: "Nagarhole"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.0280, 76.1262], name: "Nagarhole"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.0280, 76.1262], name: "Nagarhole"}
      ]
    }
  },
  "bijapur": { 
    coords: [16.8302, 75.7100],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [16.8302, 75.7100], name: "Bijapur"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [16.8302, 75.7100], name: "Bijapur"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [16.8302, 75.7100], name: "Bijapur"}
      ]
    }
  },
  "bidar": { 
    coords: [17.9229, 77.5175],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [17.9229, 77.5175], name: "Bidar"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [17.9229, 77.5175], name: "Bidar"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [17.9229, 77.5175], name: "Bidar"}
      ]
    }
  },
  "murudeshwar": { 
    coords: [14.0943, 74.4915],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.0943, 74.4915], name: "Murudeshwar"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.0943, 74.4915], name: "Murudeshwar"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.0943, 74.4915], name: "Murudeshwar"}
      ]
    }
  },
  "udupi": { 
    coords: [13.3409, 74.7421],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.3409, 74.7421], name: "Udupi"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.3409, 74.7421], name: "Udupi"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.3409, 74.7421], name: "Udupi"}
      ]
    }
  },
  "karwar": { 
    coords: [14.8136, 74.1299],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.8136, 74.1299], name: "Karwar"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.8136, 74.1299], name: "Karwar"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.8136, 74.1299], name: "Karwar"}
      ]
    }
  },
  "nandi Hills": { 
    coords: [13.3705, 77.6836],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.3705, 77.6836], name: "Nandi Hills"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.3705, 77.6836], name: "Nandi Hills"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.3705, 77.6836], name: "Nandi Hills"}
      ]
    }
  },
  "sakleshpur": { 
    coords: [12.9561, 75.7809],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.9561, 75.7809], name: "Sakleshpur"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.9561, 75.7809], name: "Sakleshpur"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.9561, 75.7809], name: "Sakleshpur"}
      ]
    }
  },
  "shivanasamudra": { 
    coords: [12.2841, 77.1609],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.2841, 77.1609], name: "Shivanasamudra"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.2841, 77.1609], name: "Shivanasamudra"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.2841, 77.1609], name: "Shivanasamudra"}
      ]
    }
  },
  "srirangapatna": { 
    coords: [12.4201, 76.6954],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.4201, 76.6954], name: "Srirangapatna"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.4201, 76.6954], name: "Srirangapatna"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.4201, 76.6954], name: "Srirangapatna"}
      ]
    }
  },
  "chitradurga": { 
    coords: [14.2254, 76.3980],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.2254, 76.3980], name: "Chitradurga"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.2254, 76.3980], name: "Chitradurga"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.2254, 76.3980], name: "Chitradurga"}
      ]
    }
  },
  "dandeli": { 
    coords: [15.2662, 74.6167],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [15.2662, 74.6167], name: "Dandeli"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [15.2662, 74.6167], name: "Dandeli"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [15.2662, 74.6167], name: "Dandeli"}
      ]
    }
  },
  "kemmangundi": { 
    coords: [13.5471, 75.7583],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.5471, 75.7583], name: "Kemmangundi"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.5471, 75.7583], name: "Kemmangundi"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.5471, 75.7583], name: "Kemmangundi"}
      ]
    }
  },
  "melukote": { 
    coords: [12.6621, 76.6487],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.6621, 76.6487], name: "Melukote"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.6621, 76.6487], name: "Melukote"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.6621, 76.6487], name: "Melukote"}
      ]
    }
  },
  "sringeri": { 
    coords: [13.4165, 75.2527],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.4165, 75.2527], name: "Sringeri"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.4165, 75.2527], name: "Sringeri"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.4165, 75.2527], name: "Sringeri"}
      ]
    }
  },
  "yana": { 
    coords: [14.5294, 74.5889],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.5294, 74.5889], name: "Yana"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.5294, 74.5889], name: "Yana"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [14.5294, 74.5889], name: "Yana"}
      ]
    }
  },
  "kudremukh": { 
    coords: [13.1344, 75.2563],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.1344, 75.2563], name: "Kudremukh"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.1344, 75.2563], name: "Kudremukh"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [13.1344, 75.2563], name: "Kudremukh"}
      ]
    }
  },
  "bylakuppe": { 
    coords: [12.4157, 75.9767],
    routes: {
      fastest: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.4157, 75.9767], name: "Bylakuppe"}
      ],
      scenic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.0889, 77.0595], name: "Munnar"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.4157, 75.9767], name: "Bylakuppe"}
      ],
      historic: [
        {coords: [9.9252, 78.1198], name: "Madurai"},
        {coords: [10.7867, 76.6548], name: "Palakkad"},
        {coords: [11.0168, 76.9558], name: "Coimbatore"},
        {coords: [12.4157, 75.9767], name: "Bylakuppe"}
      ]
    }
  }

    };

    // Get destination name from page title
const destinationName = document.querySelector('.destination-title').textContent
  .replace(' Tour', '')
  .trim()
  .toLowerCase()
  .replace(/\/$/, ''); 
  console.log("Final destination name:", destinationName); 
const destinationInfo = DESTINATION_COORDINATES[destinationName] || { 
      coords: [13.0827, 80.2707],
      routes: {
        fastest: [
          {coords: [9.9252, 78.1198], name: "Madurai"},
          {coords: [13.0827, 80.2707], name: "Chennai"}
        ]
      }
    };
console.log("Destination name from page:", destinationName);
console.log("Available destinations:", Object.keys(DESTINATION_COORDINATES));
    const destinationCoords = destinationInfo.coords;

    // Initialize the map
    const startPoint = [9.9252, 78.1198];
    const map = L.map('map').setView([
      (startPoint[0] + destinationCoords[0]) / 2,
      (startPoint[1] + destinationCoords[1]) / 2
    ], 8);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Create custom icons
    const redIcon = L.divIcon({
      className: 'red-icon',
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    });

    const waypointIcon = L.divIcon({
      className: 'waypoint-icon',
      iconSize: [12, 12],
      iconAnchor: [6, 6]
    });

    // Add markers
    L.marker(startPoint).addTo(map).bindPopup("Starting Point: Madurai");
    const destinationMarker = L.marker(destinationCoords, { icon: redIcon }).addTo(map);

    // Show route selector if multiple routes are available
    if (destinationInfo.routes && Object.keys(destinationInfo.routes).length > 1) {
      document.getElementById('routeSelector').style.display = 'block';
    }

    // Car marker setup
    const carElement = document.createElement('div');
    carElement.className = 'car-marker';
    carElement.innerHTML = `<img src="{% static 'images/topcarview.png' %}" class="car-icon" />`;

    const carIcon = L.divIcon({
      html: carElement,
      className: '',
      iconSize: [32, 32],
      iconAnchor: [16, 16],
    });

    // Animation variables
    let currentPosition = 0;
    let currentSpeed = 0;
    const targetSpeed = 0.5; // Increased speed
    const acceleration = 0.005; // Faster acceleration
    let animationId = null;
    let smoothedRoute = [];
    let currentRoute = null;
    let routeControl = null;
    let waypointMarkers = [];
    let routePointTags = [];
    let totalDistance = 0;
    let lastAngle = 0;
    const angleSmoothingFactor = 0.2;
    let lastFrameTime = 0;
    const targetFPS = 60; // Higher frame rate for smoother animation
    let hasReachedDestination = false;

    const carMarker = L.marker(startPoint, { icon: carIcon }).addTo(map);

    // Initialize Routing Machine
    const routingControl = L.Routing.control({
      waypoints: [],
      routeWhileDragging: false,
      show: false,
      addWaypoints: false,
      draggableWaypoints: false,
      fitSelectedRoutes: false,
      lineOptions: {
        styles: [{color: '#3498db', opacity: 0.7, weight: 7}]
      }
    }).addTo(map);

    // Start the trip
    fetchRoute();

    // Route selector event listener
    document.getElementById('routeOption')?.addEventListener('change', function() {
      const selectedRoute = this.value;
      if (destinationInfo.routes && destinationInfo.routes[selectedRoute]) {
        currentRoute = destinationInfo.routes[selectedRoute];
        processRoute(currentRoute);
      }
    });

    function fetchRoute() {
      if (destinationInfo.routes) {
        const routeOption = document.getElementById('routeOption')?.value || 'fastest';
        currentRoute = destinationInfo.routes[routeOption] || destinationInfo.routes.fastest;
        processRoute(currentRoute);
      } else {
        // Use Routing Machine for realistic routes
        routingControl.setWaypoints([
          L.latLng(startPoint[0], startPoint[1]),
          L.latLng(destinationCoords[0], destinationCoords[1])
        ]);
        
        routingControl.on('routesfound', function(e) {
          const routes = e.routes;
          const route = routes[0].coordinates.map(coord => [coord.lat, coord.lng]);
          processRoute([{coords: startPoint, name: "Madurai"}, {coords: destinationCoords, name: destinationName}], route);
        });
      }
    }

    function processRoute(routePoints, coordinates = null) {
      // Clear existing elements
      if (routeControl) {
        map.removeControl(routeControl);
      }
      
      waypointMarkers.forEach(marker => map.removeLayer(marker));
      waypointMarkers = [];
      
      routePointTags.forEach(tag => map.removeLayer(tag));
      routePointTags = [];

      // Reset animation state
      hasReachedDestination = false;
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }

      // Convert route to array of coordinates if it's an array of objects
      const routeCoords = coordinates || routePoints.map(point => point.coords || point);
      const routeNames = routePoints.map(point => point.name || null);

      // Calculate total distance using Routing Machine or fallback
      if (coordinates) {
        routingControl.on('routesfound', function(e) {
          totalDistance = e.routes[0].summary.totalDistance / 1000; // Convert to km
          updateRouteVisuals(routePoints, routeCoords);
        });
      } else {
        totalDistance = 0;
        for (let i = 0; i < routeCoords.length - 1; i++) {
          totalDistance += calculateDistance(
            routeCoords[i][0], routeCoords[i][1],
            routeCoords[i+1][0], routeCoords[i+1][1]
          );
        }
        updateRouteVisuals(routePoints, routeCoords);
      }
    }

    function updateRouteVisuals(routePoints, routeCoords) {
      // Add route point tags with distance information
      let cumulativeDistance = 0;
      for (let i = 0; i < routePoints.length; i++) {
        const point = routePoints[i].coords;
        const name = routePoints[i].name;
        
        if (i > 0) {
          const prevPoint = routePoints[i-1].coords;
          cumulativeDistance += calculateDistance(
            prevPoint[0], prevPoint[1],
            point[0], point[1]
          );
        }
        
        // Create tag for all route points
        const isDestination = i === routePoints.length - 1;
        const tag = L.divIcon({
          className: `route-point-tag ${isDestination ? 'destination-tag' : ''}`,
          html: `${name || (isDestination ? 'Destination' : `Point ${i+1}`)} <span class="distance-badge">${Math.round(cumulativeDistance)}km</span>`,
          iconSize: [100, 30],
          iconAnchor: [50, 30]
        });
        
        const marker = L.marker(point, { icon: tag, zIndexOffset: 1000 }).addTo(map);
        routePointTags.push(marker);
        
        // Add waypoint markers for intermediate points
        if (i > 0 && i < routePoints.length - 1) {
          const marker = L.marker(point, { icon: waypointIcon }).addTo(map);
          waypointMarkers.push(marker);
        }
      }

      // Update destination marker
      destinationMarker.setPopupContent(
        `<b>Destination:</b> ${destinationName}<br><b>Total Distance:</b> ${Math.round(totalDistance)}km`
      );

      // Create curved route using Routing Machine
      const waypoints = routePoints.map(point => 
        L.latLng(point.coords[0], point.coords[1])
      );
      
      routeControl = L.Routing.control({
        waypoints: waypoints,
        routeWhileDragging: false,
        show: false,
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        lineOptions: {
          styles: [{
            color: getRouteColor(),
            opacity: 0.7,
            weight: 7
          }]
        }
      }).addTo(map);

      // Get the actual route coordinates for animation
      routeControl.on('routesfound', function(e) {
        const routes = e.routes;
        smoothedRoute = routes[0].coordinates.map(coord => [coord.lat, coord.lng]);
        
        // Reset and start animation
        if (animationId) {
          cancelAnimationFrame(animationId);
        }
        currentPosition = 0;
        currentSpeed = 0;
        lastFrameTime = 0;
        hasReachedDestination = false;
        startTrip();
      });
    }

    function getRouteColor() {
      if (!destinationInfo.routes) return '#3498db';
      
      const routeOption = document.getElementById('routeOption')?.value || 'fastest';
      if (routeOption === 'scenic') return '#27ae60';
      if (routeOption === 'historic') return '#e67e22';
      return '#3498db';
    }

    // Haversine formula for distance calculation
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function deg2rad(deg) {
      return deg * (Math.PI/180);
    }

    function startTrip() {
      lastFrameTime = 0;
      animationId = requestAnimationFrame(animate);
    }

    function animate(timestamp) {
      if (!lastFrameTime) lastFrameTime = timestamp;
      const deltaTime = timestamp - lastFrameTime;
      
      if (deltaTime >= 1000 / targetFPS) {
          lastFrameTime = timestamp;
          
          // Speed control
          if (currentSpeed < targetSpeed) {
              currentSpeed = Math.min(currentSpeed + acceleration, targetSpeed);
          }
          
          currentPosition += currentSpeed / 1000;
          
          if (currentPosition >= 1) {
              currentPosition = 1;
              currentSpeed = 0;
              updateCarPosition(currentPosition);
              if (!hasReachedDestination) {
                triggerConfetti();
                hasReachedDestination = true;
              }
              return;
          }
          
          updateCarPosition(currentPosition);
      }
      
      animationId = requestAnimationFrame(animate);
    }

    function cubicInterpolate(y0, y1, y2, y3, mu) {
      const mu2 = mu * mu;
      const a0 = y3 - y2 - y0 + y1;
      const a1 = y0 - y1 - a0;
      const a2 = y2 - y0;
      const a3 = y1;
      return a0 * mu * mu2 + a1 * mu2 + a2 * mu + a3;
    }

    function updateCarPosition(progress) {
      const exactIndex = progress * (smoothedRoute.length - 1);
      const index = Math.floor(exactIndex);
      const nextIndex = Math.min(index + 1, smoothedRoute.length - 1);
      const partialProgress = exactIndex % 1;

      // Use cubic interpolation for smoother movement
      const prevIndex = Math.max(index - 1, 0);
      const nextNextIndex = Math.min(index + 2, smoothedRoute.length - 1);
      
      const currentPoint = smoothedRoute[index];
      const nextPoint = smoothedRoute[nextIndex];
      const prevPoint = smoothedRoute[prevIndex];
      const nextNextPoint = smoothedRoute[nextNextIndex];

      // Cubic interpolation for latitude
      const lat = cubicInterpolate(
          prevPoint[0], currentPoint[0], nextPoint[0], nextNextPoint[0], 
          partialProgress
      );
      
      // Cubic interpolation for longitude
      const lng = cubicInterpolate(
          prevPoint[1], currentPoint[1], nextPoint[1], nextNextPoint[1], 
          partialProgress
      );

      // Update car position
      carMarker.setLatLng([lat, lng]);
      
      // Calculate angle between current and next point
      const rawAngle = calculateAngle(currentPoint, nextPoint);
      const smoothedAngle = lastAngle + angleSmoothingFactor * (rawAngle - lastAngle);
      lastAngle = smoothedAngle;
      
      // Update car rotation
      carElement.style.setProperty('--rotation', `${smoothedAngle}deg`);
      
      // Smooth panning
      const bounds = map.getBounds();
      if (!bounds.contains([lat, lng])) {
          map.panTo([lat, lng], { animate: true, duration: 0.5 });
      }
    }

    function calculateAngle(currentPos, nextPos) {
      const dx = nextPos[1] - currentPos[1];
      const dy = nextPos[0] - currentPos[0];
      return Math.atan2(dx, dy) * 180 / Math.PI;
    }

    function triggerConfetti() {
      // Get the destination position on screen
      const destPoint = map.latLngToContainerPoint(destinationMarker.getLatLng());
      const x = destPoint.x / map.getSize().x;
      const y = destPoint.y / map.getSize().y;
      
      // Confetti configuration
      const colors = ['#8e44ad', '#e67e22', '#27ae60', '#3498db', '#f1c40f'];
      
      // Create confetti effect
      const end = Date.now() + 3000; // 3 seconds of confetti
      
      (function frame() {
        // Launch from left side
        confetti({
          particleCount: 5,
          angle: 60,
          spread: 55,
          origin: { x, y },
          colors: colors
        });
        
        // Launch from right side
        confetti({
          particleCount: 5,
          angle: 120,
          spread: 55,
          origin: { x, y },
          colors: colors
        });
        
        // Launch from bottom
        confetti({
          particleCount: 5,
          angle: -90,
          spread: 55,
          origin: { x, y },
          colors: colors
        });
        
        // Continue if we're not done yet
        if (Date.now() < end) {
          requestAnimationFrame(frame);
        }
        
        // Open destination popup
        destinationMarker.openPopup();
      }());
    }
  </script>
</body>
</html>
{% endblock %}